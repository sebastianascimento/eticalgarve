<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do List</title>
    <style>
        .task-list {
            list-style-type: none;
            padding: 0;
        }
        .task-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ccc;
        }
        .task-item.completed {
            text-decoration: line-through;
        }
        .task-toggle {
            margin-right: 10px;
        }
        .urgency {
            margin-left: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>To-Do List</h1>
    <to-do-list></to-do-list>

    <template id="task-template">
        <li class="task-item">
            <task-toggle-button class="task-toggle"></task-toggle-button>
            <span class="task-name"></span>
            <span class="urgency"></span>
            <button class="remove-task">Remover</button>
        </li>
    </template>

    <script>
        // Definição da classe TaskToggleButton
        class TaskToggleButton extends HTMLElement {
            static observedAttributes = [];
            shadowRoot;
            #toggled = false;

            constructor() {
                super();
                this.shadowRoot = this.attachShadow({ mode: 'closed' });
                const button = document.createElement('button');
                button.textContent = 'Completar';
                button.onclick = () => {
                    this.#toggled = !this.#toggled;
                    this.toggle();
                    const event = new CustomEvent('toggle', { detail: { completed: this.#toggled } });
                    this.dispatchEvent(event);
                };
                this.shadowRoot.appendChild(button);
            }

            toggle() {
                const button = this.shadowRoot.querySelector('button');
                button.textContent = this.#toggled ? 'Desmarcar' : 'Completar';
            }
        }
        customElements.define('task-toggle-button', TaskToggleButton);

        // Definição da classe ToDoList
        class ToDoList extends HTMLElement {
            constructor() {
                super();
                this.pendingTasks = [];
                this.completedTasks = [];
                this.attachShadow({ mode: 'open' });
                this.shadowRoot.innerHTML = `
                    <input type="text" placeholder="Adicionar nova tarefa" id="new-task-input">
                    <select id="urgency-select">
                        <option value="1">Alta</option>
                        <option value="2">Média</option>
                        <option value="3">Baixa</option>
                    </select>
                    <button id="add-task-button">Adicionar Tarefa</button>
                    <h2>Tarefas Pendentes</h2>
                    <ul id="pending-task-list" class="task-list"></ul>
                    <h2>Tarefas Concluídas</h2>
                    <ul id="completed-task-list" class="task-list"></ul>
                `;
                this.shadowRoot.querySelector('#add-task-button').onclick = () => this.addTask();
                this.loadTasks();
            }

            async loadTasks() {
                const response = await fetch('tasks.json');
                const data = await response.json();
                this.pendingTasks = data.pendingTasks || [];
                this.completedTasks = data.completedTasks || [];
                this.renderTasks();
            }

            async saveTasks() {
                const data = {
                    pendingTasks: this.pendingTasks,
                    completedTasks: this.completedTasks
                };
                await fetch('tasks.json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
            }

            addTask() {
                const input = this.shadowRoot.querySelector('#new-task-input');
                const taskName = input.value.trim();
                const urgencySelect = this.shadowRoot.querySelector('#urgency-select');
                const urgency = parseInt(urgencySelect.value);

                if (taskName) {
                    this.pendingTasks.push({ name: taskName, completed: false, urgency: urgency });
                    this.pendingTasks.sort((a, b) => a.urgency - b.urgency);
                    this.saveTasks();
                    this.renderTasks();
                    input.value = '';
                }
            }

            removeTask(index, list) {
                list.splice(index, 1);
                this.saveTasks();
                this.renderTasks();
            }

            toggleTaskCompletion(index, list, targetList) {
                const task = list.splice(index, 1)[0];
                task.completed = !task.completed;
                targetList.push(task);
                targetList.sort((a, b) => a.urgency - b.urgency);
                this.saveTasks();
                this.renderTasks();
            }

            renderTasks() {
                const pendingTaskList = this.shadowRoot.querySelector('#pending-task-list');
                const completedTaskList = this.shadowRoot.querySelector('#completed-task-list');
                pendingTaskList.innerHTML = '';
                completedTaskList.innerHTML = '';

                this.pendingTasks.forEach((task, index) => {
                    const template = document.querySelector('#task-template');
                    const clone = template.content.cloneNode(true);

                    const taskItem = clone.querySelector('.task-item');
                    const taskName = clone.querySelector('.task-name');
                    taskName.textContent = task.name;

                    const urgency = clone.querySelector('.urgency');
                    urgency.textContent = `Urgência: ${task.urgency}`;

                    const taskToggle = clone.querySelector('task-toggle-button');
                    taskToggle.addEventListener('toggle', () => this.toggleTaskCompletion(index, this.pendingTasks, this.completedTasks));

                    const removeButton = clone.querySelector('.remove-task');
                    removeButton.onclick = () => this.removeTask(index, this.pendingTasks);

                    pendingTaskList.appendChild(clone);
                });

                this.completedTasks.forEach((task, index) => {
                    const template = document.querySelector('#task-template');
                    const clone = template.content.cloneNode(true);

                    const taskItem = clone.querySelector('.task-item');
                    taskItem.classList.add('completed');
                    const taskName = clone.querySelector('.task-name');
                    taskName.textContent = task.name;

                    const urgency = clone.querySelector('.urgency');
                    urgency.textContent = `Urgência: ${task.urgency}`;

                    const taskToggle = clone.querySelector('task-toggle-button');
                    taskToggle.addEventListener('toggle', () => this.toggleTaskCompletion(index, this.completedTasks, this.pendingTasks));

                    const removeButton = clone.querySelector('.remove-task');
                    removeButton.onclick = () => this.removeTask(index, this.completedTasks);

                    completedTaskList.appendChild(clone);
                });
            }
        }
        customElements.define('to-do-list', ToDoList);
    </script>
</body>
</html>
